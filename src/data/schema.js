import {
	GraphQLEnumType,
	GraphQLInt,
	GraphQLList,
	GraphQLNonNull,
	GraphQLObjectType,
	GraphQLSchema,
	GraphQLString,
} from 'graphql';

import {
	GraphQLLong,
} from '../types/GraphQLLong';

import {
	connectionArgs,
	connectionDefinitions,
	connectionFromPromisedArray,
	fromGlobalId,
	globalIdField,
	mutationWithClientMutationId,
	nodeDefinitions,
	offsetToCursor,
	toGlobalId,
} from 'graphql-relay';

import {
	Item,
	Provider,
	User,
	addItem,
	addProvider,
	getItem,
	getItems,
	getProvider,
	getProviders,
	getUser,
	getViewer,
} from './database';

const { nodeInterface, nodeField } = nodeDefinitions(
	globalId => {
		const { type, id } = fromGlobalId(globalId);
		if (type === 'Item') {
			return getItem(id);
		} else if (type === 'User') {
			return getUser(id);
		} else if (type === 'Provider') {
			return getProvider(id);
		}
		return null;
	},
	obj => {
		if (obj instanceof Item) {
			return GraphQLItem; // eslint-disable-line no-use-before-define
		} else if (obj instanceof User) {
			return GraphQLUser; // eslint-disable-line no-use-before-define
		} else if (obj instanceof Provider) {
			return GraphQLProvider; // eslint-disable-line no-use-before-define
		}
		return null;
	}
);

const GraphQLStatusEnum = new GraphQLEnumType({
	name: 'Status',
	description: 'The item\'s status',
	values: {
		PENDING: {
			value: 'Pending',
			description: 'Unviewed',
		},
		COMPLETE: {
			value: 'Complete',
			description: 'Viewed',
		},
	},
});

const GraphQLProductionStatusEnum = new GraphQLEnumType({
	name: 'ProductionStatus',
	description: 'The item\'s production status',
	values: {
		INCOMPLETE: {
			value: 'Incomplete',
		},
		COMPLETE: {
			value: 'Complete',
		},
		HIATUS: {
			value: 'Hiatus',
		},
		CANCELLED: {
			value: 'Cancelled',
		},
	},
});

const GraphQLItem = new GraphQLObjectType({
	name: 'Item',
	description: 'A media item',
	fields: () => ({
		id: globalIdField('Item'),
		providerCollisionId: {
			type: GraphQLString,
			description: 'An id for this item, generated by the provider',
		},
		url: {
			type: GraphQLString,
			description: 'The item\'s URL',
		},
		thumbnail: {
			type: GraphQLString,
			description: 'The item\'s thumbnail URL',
		},
		title: {
			type: GraphQLString,
			description: 'The item\'s title',
		},
		creator: {
			type: GraphQLString,
			description: 'The item\'s creator',
		},
		genres: {
			type: new GraphQLList(GraphQLString),
			description: 'A list of the item\'s genres',
		},
		characters: {
			type: new GraphQLList(GraphQLString),
			description: 'A list of the item\'s characters',
		},
		length: {
			type: GraphQLInt,
			description: 'The item\'s length',
		},
		status: {
			type: GraphQLStatusEnum,
			description: 'The item\'s status',
		},
		productionStatus: {
			type: GraphQLProductionStatusEnum,
			description: 'The item\'s production status',
		},
		statusDate: {
			type: new GraphQLNonNull(GraphQLLong),
			description: 'The date at which the item\'s status was last updated',
		},
		date: {
			type: new GraphQLNonNull(GraphQLLong),
			description: 'The date at which this version of the item was updated',
		},
	}),
	interfaces: [nodeInterface],
});

const {
	connectionType: ItemsConnection,
	edgeType: GraphQLItemEdge,
} = connectionDefinitions({
	name: 'Item',
	nodeType: GraphQLItem,
});

const GraphQLProvider = new GraphQLObjectType({
	name: 'Provider',
	description: 'A media provider',
	fields: () => ({
		id: globalIdField('Provider'),
		infoCallback: {
			type: GraphQLString,
			description: 'The provider\'s info fetching callback. ' +
				'Should accept one param `url`, returning false ' +
				'if the url cannot be handled by this provider, ' +
				'or a Promise resolving to a GraphQLItem otherwise.',
		},
	}),
	interfaces: [nodeInterface],
});

const {
	connectionType: ProvidersConnection,
	edgeType: GraphQLProviderEdge,
} = connectionDefinitions({
	name: 'Provider',
	nodeType: GraphQLProvider,
});

const GraphQLUser = new GraphQLObjectType({
	name: 'User',
	fields: {
		id: globalIdField('User'),
		items: {
			type: ItemsConnection,
			args: {
				...connectionArgs,
			},
			resolve: (obj, args) =>
				connectionFromPromisedArray(getItems(), args),
		},
		providers: {
			type: ProvidersConnection,
			args: {
				...connectionArgs,
			},
			resolve: (obj, args) =>
				connectionFromPromisedArray(getProviders(), args),
		},
	},
});

const Query = new GraphQLObjectType({
	name: 'Query',
	fields: () => ({
		node: nodeField,
		viewer: {
			type: GraphQLUser,
			resolve: () => getViewer(),
		},
	}),
});

function randomId(length = 16) {
	let id = '';
	while (id.length < length) {
		id += String(Math.random()).slice(2);
	}
	return id.slice(0, length);
}

const GraphQLAddItemMutation = mutationWithClientMutationId({
	name: 'AddItem',
	inputFields: {},
	outputFields: {
		itemEdge: {
			type: GraphQLItemEdge,
			resolve: async ({ itemId }) => {
				const items = await getItems();
				const offset = items.findIndex(({ id }) => id === itemId);
				return {
					cursor: offsetToCursor(offset),
					node: items[offset],
				};
			},
		},
		viewer: {
			type: GraphQLUser,
			resolve: () => getViewer(),
		},
	},
	mutateAndGetPayload: () => {
		const itemId = toGlobalId('Item', randomId());
		addItem(itemId);
		return { itemId };
	},
});

const GraphQLAddProviderMutation = mutationWithClientMutationId({
	name: 'AddProvider',
	inputFields: {},
	outputFields: {
		providerEdge: {
			type: GraphQLProviderEdge,
			resolve: async ({ providerId }) => {
				const providers = await getProviders();
				const offset = providers.findIndex(({ id }) => id === providerId);
				return {
					cursor: offsetToCursor(offset),
					node: providers[offset],
				};
			},
			viewer: {
				type: GraphQLUser,
				resolve: () => getViewer(),
			},
		},
	},
	mutateAndGetPayload: () => {
		const providerId = toGlobalId('Provider', randomId());
		addProvider(providerId);
		return { providerId };
	},
});

const Mutation = new GraphQLObjectType({
	name: 'Mutation',
	fields: () => ({
		addItem: GraphQLAddItemMutation,
		addProvider: GraphQLAddProviderMutation,
	}),
});

export default new GraphQLSchema({
	query: Query,
	mutation: Mutation,
});
